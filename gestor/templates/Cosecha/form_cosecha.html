{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %} | Formulario Corte {% endblock %}

{% block content %}
<div class="container py-3">
  <div class="row row-cols-1 row-cols-lg-2 g-4">
    
    <!-- Formulario de Cosecha -->
    <div class="col">
      <div class="card shadow-sm h-100 w-100">
        <div class="card-header bg-primary text-white fw-bold">
          {% if form.instance.pk %} Editar Corte {% else %} Nuevo Corte {% endif %}
        </div>
        <div class="card-body">
          <form id="form-cosecha" method="post">
            {% csrf_token %}
            <div class="text-center mb-4">
              {% if plantacion %}
              <input type="hidden" name="plantacion_id" value="{{ plantacion.idplantacion }}">
              <div class="mb-3 py-2">
                <label class="form-label fw-bold">Parcela: {{ plantacion.parcela.nombre }} - Cultivo: {{ plantacion.cultivo.nombre }}</label>
              </div>
              {% endif %}
            </div>
            {{ form|crispy }}

            <!-- Categor칤a -->
            <div class="mb-3">
            <label for="categoria">Categor칤a</label>
            <select id="categoria" class="form-select" name="categoria">
                <option value="">Seleccione una categor칤a</option>
                {% for value, label in categoria_choices %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
            </div>

            <!-- Tipo de corte -->
            <div class="mb-3">
            <label for="tipocosecha">Tipo de cosecha</label>
            <select id="tipocosecha" class="form-select" name="tipocosecha">
                <option value="">Primero seleccione una categor칤a</option>
            </select>
            <small class="form-text text-muted">Los tipos de cosecha se actualizan seg칰n la categor칤a seleccionada</small>
            </div>

            <div class="mb-3">
              <label for="cantidad">Cantidad</label>
              <input type="number" class="form-control" id="cantidad" name="cantidad" min="1">
              <small class="form-text text-muted">Para tipos diferentes a "Unidad", se aplicar치 autom치ticamente el multiplicador del cultivo</small>
            </div>

            <input type="hidden" name="cortes_json" id="cortes_json">

            <button type="button" class="btn btn-success" id="agregar-corte">Agregar</button>
            <button type="submit" class="btn btn-primary" id="guardar-btn" disabled>Guardar</button>
            
            <a href="{% url 'lista_cosechas' %}" class="btn btn-secondary">Cancelar</a>
          </form>
        </div>
      </div>
    </div>

    <!-- Lista de Cortes Agregados -->
    <div class="col">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-success text-white fw-bold">
          <i class="bi bi-list-check"></i> Cortes Agregados
        </div>
        <div class="card-body">
          {% if vendida_primera or vendida_segunda or vendida_tercera %}
          <div class="alert alert-info">
            <strong>Cantidades ya vendidas:</strong><br>
            Primera: {{ vendida_primera|default:0 }} | 
            Segunda: {{ vendida_segunda|default:0 }} | 
            Tercera: {{ vendida_tercera|default:0 }}
          </div>
          {% endif %}
          <ul id="cortes-lista" class="list-group mb-3"></ul>
          <p id="total-general" class="mt-2 fw-bold">Total Unidades: 0</p>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const categoria = document.getElementById('categoria');
  const tipocosecha = document.getElementById('tipocosecha');
  const cantidad = document.getElementById('cantidad');
  const cortesLista = document.getElementById('cortes-lista');
  const cortesJson = document.getElementById('cortes_json');
  const totalGeneral = document.getElementById('total-general');
  const agregarBtn = document.getElementById('agregar-corte');

  // Obtener el ID de la plantaci칩n desde el template
  const plantacionId = {{ plantacion.idplantacion|default:"null" }};

  // Variables para almacenar tipos disponibles y multiplicadores
  let tiposDisponibles = [];
  let multiplicadores = {};

  function actualizarEstadoBotonGuardar() {
    const guardarBtn = document.getElementById('guardar-btn');
    const habilitado = cortes.length > 0;
    guardarBtn.disabled = !habilitado;
  }

  // Funci칩n para cargar los tipos de cosecha disponibles seg칰n la plantaci칩n
  function cargarTiposCosecha() {
    if (!plantacionId) {
      tipocosecha.innerHTML = '<option value="">No hay plantaci칩n seleccionada</option>';
      return;
    }

    // Hacer petici칩n AJAX para obtener los tipos de cosecha disponibles
    fetch(`/ajax/obtener-tipos-cosecha/?plantacion_id=${plantacionId}`)
      .then(response => response.json())
      .then(data => {
        tiposDisponibles = data.tipos || [];
        multiplicadores = data.multiplicadores || {};
        actualizarSelectTipoCosecha();
      })
      .catch(error => {
        console.error('Error al cargar tipos de cosecha:', error);
        tipocosecha.innerHTML = '<option value="">Error al cargar opciones</option>';
      });
  }

  // Funci칩n para actualizar el select de tipo de cosecha seg칰n la categor칤a seleccionada
  function actualizarSelectTipoCosecha() {
    const categoriaSeleccionada = categoria.value;
    tipocosecha.innerHTML = '<option value="">Seleccione tipo de corte</option>';

    if (!categoriaSeleccionada) {
      tipocosecha.innerHTML = '<option value="">Primero seleccione una categor칤a</option>';
      return;
    }

    // Filtrar tipos disponibles para la categor칤a seleccionada
    const tiposFiltrados = tiposDisponibles.filter(tipo => 
      tipo.categoria === categoriaSeleccionada
    );

    // Agregar las opciones al select
    tiposFiltrados.forEach(tipo => {
      const option = document.createElement('option');
      option.value = tipo.value;
      option.textContent = tipo.label;
      option.dataset.multiplicador = tipo.cantidad || 1;
      tipocosecha.appendChild(option);
    });

    if (tiposFiltrados.length === 0) {
      tipocosecha.innerHTML = '<option value="">No hay tipos disponibles para esta categor칤a</option>';
    }
  }

  // Event listener para cuando cambie la categor칤a
  categoria.addEventListener('change', actualizarSelectTipoCosecha);

  // Cargar los tipos de cosecha al inicializar la p치gina
  cargarTiposCosecha();

  // 游댳 Inicializamos con los detalles existentes si estamos editando
  let cortes = [];
  
  // Si tenemos datos del template (al editar), usarlos
  {% if detalles_json %}
  cortes = JSON.parse('{{ detalles_json|escapejs }}');
  {% endif %}
  
  // Si tenemos multiplicadores del template (al editar), usarlos
  {% if multiplicadores %}
  multiplicadores = JSON.parse('{{ multiplicadores|escapejs }}');
  {% endif %}
  
  // Si tenemos tipos disponibles del template (al editar), usarlos
  {% if tipos_disponibles %}
  tiposDisponibles = JSON.parse('{{ tipos_disponibles|escapejs }}');
  {% endif %}

  function getLabel(selectElement, value) {
    const option = [...selectElement.options].find(opt => opt.value === value);
    if (option) return option.text;
    
    // Si no encontramos en el select, buscar en los arrays de choices
    const categoriaChoices = {
      'primera': 'Primera',
      'segunda': 'Segunda', 
      'tercera': 'Tercera'
    };
    
    const tipoChoices = {
      'S': 'Saco',
      'U': 'Unidad',
      'C': 'Caja',
      'Lb': 'Libra'
    };
    
    return categoriaChoices[value] || tipoChoices[value] || value;
  }

  function getMultiplicador(categoria, tipocosecha) {
    const clave = `${categoria}_${tipocosecha}`;
    return multiplicadores[clave] || 1;
  }

  function actualizarLista() {
    cortesLista.innerHTML = '';
    let totalUnidades = 0;

    cortes.forEach((corte, index) => {
      // Calcular unidades totales aplicando multiplicador
      const multiplicador = getMultiplicador(corte.categoria, corte.tipocosecha);
      const unidadesTotales = parseInt(corte.cantidad) * multiplicador;
      totalUnidades += unidadesTotales;

      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';
      
      let detalleTexto = `<strong>${getLabel(categoria, corte.categoria)}</strong> - ${corte.cantidad} ${getLabel(tipocosecha, corte.tipocosecha)}`;
      
      // Si no es unidad, mostrar el c치lculo
      if (corte.tipocosecha !== 'U' && multiplicador > 1) {
        detalleTexto += ` <small class="text-muted">(${corte.cantidad} 칑 ${multiplicador} = ${unidadesTotales} unidades)</small>`;
      } else if (corte.tipocosecha === 'U') {
        detalleTexto += ` <small class="text-muted">(= ${unidadesTotales} unidades)</small>`;
      }

      li.innerHTML = `
        <div>${detalleTexto}</div>
        <button class="btn btn-sm btn-danger eliminar-corte" data-index="${index}">
          <i class="bi bi-trash"></i>
        </button>
      `;
      cortesLista.appendChild(li);
    });

    totalGeneral.innerHTML = `<strong>Total Unidades: ${totalUnidades}</strong>`;
    cortesJson.value = JSON.stringify(cortes);
  }

  // 游댳 Inicializamos la lista al cargar
  actualizarLista();
  actualizarEstadoBotonGuardar();

  agregarBtn.addEventListener('click', function () {
    const cat = categoria.value;
    const tipo = tipocosecha.value;
    const cant = parseInt(cantidad.value);

    if (!cat || !tipo || isNaN(cant) || cant <= 0) {
      Swal.fire({
        icon: 'warning',
        title: 'Datos inv치lidos',
        text: 'Por favor completa todos los campos correctamente.',
        timer: 2500,
        showConfirmButton: false
      });
      return;
    }

    // Verificar si ya existe esta combinaci칩n
    const existeCombo = cortes.some(corte => 
      corte.categoria === cat && corte.tipocosecha === tipo
    );

    if (existeCombo) {
      Swal.fire({
        icon: 'warning',
        title: 'Combinaci칩n duplicada',
        text: 'Ya existe un corte con esta categor칤a y tipo de cosecha.',
        timer: 2500,
        showConfirmButton: false
      });
      return;
    }

    cortes.push({
      categoria: cat,
      tipocosecha: tipo,
      cantidad: cant
    });

    actualizarLista();
    actualizarEstadoBotonGuardar();

    categoria.selectedIndex = 0;
    tipocosecha.innerHTML = '<option value="">Primero seleccione una categor칤a</option>';
    cantidad.value = '';
  });

  cortesLista.addEventListener('click', function (e) {
    if (e.target.closest('.eliminar-corte')) {
      const index = e.target.closest('.eliminar-corte').getAttribute('data-index');
      cortes.splice(index, 1);
      actualizarLista();
      actualizarEstadoBotonGuardar();
    }
  });
});
</script>
{% endblock %}