{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %} | Dashboard {% endblock title %}

{% block content %}

<h1 class="welcome-title">¬°Bienvenido! {{ user }}</h1>
   
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-2">
    <h2 class="fw-bold text-center text-md-start">Sistema de producci√≥n</h2>
    <div class="d-flex flex-column flex-sm-row gap-2">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalSeleccionarCliente">
            <i class="bi bi-plus-circle"></i> Venta
        </button>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalSeleccionarPlantacion">
            <i class="bi bi-plus-circle"></i> Corte
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalSeleccionarProveedor">
            <i class="bi bi-plus-circle"></i> Compra
        </button>
        <a href="{% url 'agregarplanilla' %}" class="btn btn-success">
                                    <i class="fas fa-plus"></i> Asistencia
                                </a>
    </div>
</div>

<!-- Resumen Diario -->
<h3 class="fw-bold mb-4">Resumen Diario</h3>

<div class="row g-3">
{% if cosechas_hoy_detalle %}
  {% for cultivo, tipos in cosechas_hoy_detalle.items %}
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card shadow-sm border-success h-100">
        <div class="card-header bg-success text-white text-center fw-bold text-uppercase py-2 small">
          {{ cultivo }}
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm table-bordered text-center mb-0 align-middle">
              <thead class="table-success">
                <tr class="small">
                  <th>Tipo</th>
                  <th><i class="bi bi-star-fill text-success"></i> P</th>
                  <th><i class="bi bi-star-half text-info"></i> S</th>
                  <th><i class="bi bi-star text-warning"></i> T</th>
                </tr>
              </thead>
              <tbody>
                {% for tipo, calidades in tipos.items %}
                  <tr class="small">
                    <td class="fw-bold text-capitalize">{{ tipo }}</td>
                    <td>{{ calidades.primera|default:0 }}</td>
                    <td>{{ calidades.segunda|default:0 }}</td>
                    <td>{{ calidades.tercera|default:0 }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
{% else %}
  <div class="col-12">
    <div class="alert alert-info text-center">
      <i class="bi bi-info-circle"></i> No hay cosechas registradas para hoy
    </div>
  </div>
{% endif %}

<div class="col-12 col-md-6 col-lg-4">
    <div class="card h-100 text-white bg-primary text-center shadow-sm">
        <div class="card-header fw-bold">
            <i class="bi bi-cash-coin"></i> Ventas
        </div>
        <div class="card-body">
            <p class="mb-1 text-uppercase">Del d√≠a</p>
            <p class="fw-bold fs-4">${{ total_ventas }}</p>
        </div>
    </div>
</div>

<div class="col-12 col-md-6 col-lg-4">
    <div class="card h-100 text-white bg-secondary text-center shadow-sm">
        <div class="card-header fw-bold">
            <i class="bi bi-cart-fill"></i> Compras
        </div>
        <div class="card-body">
            <p class="mb-1 text-uppercase">Del d√≠a</p>
            <p class="fw-bold fs-4">${{ total_compras }}</p>
        </div>
    </div>
</div>

</div>

<!-- Secci√≥n de gr√°ficos -->
<div class="row g-4 mb-4 mt-4">
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white fw-bold d-flex justify-content-between align-items-center">
                <span>Producci√≥n diaria</span>
                <select id="selectCultivo" class="form-select form-select-sm" style="width: auto; background-color: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white;">
                    {% for cultivo in cultivos_hoy_lista %}
                        <option value="{{ cultivo }}" style="color: black;">{{ cultivo }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="card-body">
                <canvas id="calidadChart" style="height: 350px;"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white fw-bold">Ventas diarias</div>
            <div class="card-body">
                <canvas id="ventasChart" style="height: 350px;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Scripts y datos para JavaScript -->
<script>
// Pasar datos de Django a JavaScript
window.dashboardData = {
    diasSemana: {{ dias_semana|safe }},
    ventasPorDia: {{ ventas_por_dia|safe }},
    calidadPorCultivo: {{ calidad_por_cultivo|safe }},
    cultivosHoy: {{ cultivos_hoy|safe }}
};

console.log('üìä Datos recibidos del servidor:', window.dashboardData);
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Verificar que los datos est√©n disponibles
    if (!window.dashboardData) {
        console.error('‚ùå No se encontraron datos del dashboard');
        return;
    }

    const { diasSemana, ventasPorDia, calidadPorCultivo, cultivosHoy } = window.dashboardData;

    // Funci√≥n para detectar si estamos en modo oscuro
    function getChartColors() {
        const dark = document.body.classList.contains('dark-mode') || 
                     document.documentElement.classList.contains('dark-mode') ||
                     window.matchMedia('(prefers-color-scheme: dark)').matches;
        return {
            text: dark ? '#ffffff' : '#333333',
            grid: dark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
            tooltipBg: dark ? '#2d2d2d' : '#ffffff',
            tooltipText: dark ? '#ffffff' : '#000000'
        };
    }

    const colors = getChartColors();

    // C√ìDIGO PARA BOTONES
    const btnCorte = document.getElementById("btnIrFormularioCorte");
    const btnVenta = document.getElementById("btnIrFormulario");

    if (btnCorte) {
        btnCorte.addEventListener("click", function () {
            const plantacionId = document.getElementById("selectPlantacion")?.value;
            if (plantacionId) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalSeleccionarPlantacion'));
                if (modal) modal.hide();
                setTimeout(() => {
                    window.location.href = `/cosechas/crear/?plantacion_id=${plantacionId}`;
                }, 300);
            } else {
                alert("Debes seleccionar una plantaci√≥n.");
            }
        });
    }

    if (btnVenta) {
        btnVenta.addEventListener("click", function () {
            const clienteId = document.getElementById("selectCliente")?.value;
            if (clienteId) {
                window.location.href = `/ventas/crear/?cliente_id=${clienteId}`;
            } else {
                alert("Debes seleccionar un cliente.");
            }
        });
    }
    // Bot√≥n para ir al formulario de nueva compra
    document.getElementById("btnIrFormulario").addEventListener("click", function () {
        const proveedorId = document.getElementById("selectProveedor").value;
        if (proveedorId) {
            window.location.href = `/compras/crear/?proveedor_id=${proveedorId}`;
        } else {
            alert("Debes seleccionar un proveedor.");
        }
    }); 

    // 1. GR√ÅFICO DE VENTAS
    const ventasChartElement = document.getElementById('ventasChart');
    if (ventasChartElement && diasSemana && ventasPorDia) {
        const ventasChart = new Chart(ventasChartElement, {
            type: 'bar',
            data: {
                labels: diasSemana,
                datasets: [{
                    label: 'Ventas ($)',
                    data: ventasPorDia,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    borderRadius: 8,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Ventas por D√≠a de la Semana',
                        color: colors.text,
                        font: { size: 16, weight: 'bold' },
                        padding: { bottom: 20 }
                    },
                    legend: {
                        display: true,
                        labels: { 
                            color: colors.text,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        backgroundColor: colors.tooltipBg,
                        titleColor: colors.tooltipText,
                        bodyColor: colors.tooltipText,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(ctx) {
                                return 'Ventas: $' + ctx.parsed.y.toLocaleString('es-ES', {
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 2
                                });
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: colors.text,
                            font: { size: 11 },
                            callback: function(value) {
                                return '$' + value.toLocaleString('es-ES');
                            }
                        },
                        grid: { 
                            color: colors.grid,
                            drawBorder: false
                        },
                        title: {
                            display: true,
                            text: 'Ventas ($)',
                            color: colors.text,
                            font: { size: 12, weight: 'bold' }
                        }
                    },
                    x: {
                        ticks: { 
                            color: colors.text,
                            font: { size: 11 }
                        },
                        grid: { 
                            display: false 
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                }
            }
        });
    } else {
        console.error('‚ùå No se pudo crear el gr√°fico de ventas - Elemento o datos faltantes');
    }

    // 2. GR√ÅFICO DE CALIDAD/PRODUCCI√ìN
    const calidadChartElement = document.getElementById('calidadChart');
    const selectCultivo = document.getElementById('selectCultivo');
    
    if (calidadChartElement && selectCultivo && calidadPorCultivo && cultivosHoy.length > 0) {
        let cultivoSeleccionado = cultivosHoy[0]; // Primer cultivo por defecto
        selectCultivo.value = cultivoSeleccionado;
        
        function obtenerDatosCultivo(cultivo) {
            const datos = calidadPorCultivo[cultivo];
            if (!datos) {
                console.warn(`‚ö†Ô∏è No hay datos para el cultivo: ${cultivo}`);
                return {
                    primera: [0,0,0,0,0,0,0],
                    segunda: [0,0,0,0,0,0,0],
                    tercera: [0,0,0,0,0,0,0]
                };
            }
            return datos;
        }

        const calidadChart = new Chart(calidadChartElement, {
            type: 'bar',
            data: {
                labels: ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'],
                datasets: [
                    {
                        label: 'Primera Calidad',
                        data: obtenerDatosCultivo(cultivoSeleccionado).primera,
                        backgroundColor: 'rgba(34, 197, 94, 0.8)',
                        borderColor: 'rgba(34, 197, 94, 1)',
                        borderWidth: 2,
                        borderRadius: 4
                    },
                    {
                        label: 'Segunda Calidad',
                        data: obtenerDatosCultivo(cultivoSeleccionado).segunda,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        borderRadius: 4
                    },
                    {
                        label: 'Tercera Calidad',
                        data: obtenerDatosCultivo(cultivoSeleccionado).tercera,
                        backgroundColor: 'rgba(245, 158, 11, 0.8)',
                        borderColor: 'rgba(245, 158, 11, 1)',
                        borderWidth: 2,
                        borderRadius: 4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `Cosechas de ${cultivoSeleccionado} por Calidad`,
                        color: colors.text,
                        font: { size: 16, weight: 'bold' },
                        padding: { bottom: 20 }
                    },
                    legend: {
                        display: true,
                        position: 'top',
                        labels: { 
                            color: colors.text,
                            font: { size: 12 },
                            padding: 15
                        }
                    },
                    tooltip: {
                        backgroundColor: colors.tooltipBg,
                        titleColor: colors.tooltipText,
                        bodyColor: colors.tooltipText,
                        borderColor: 'rgba(34, 197, 94, 1)',
                        borderWidth: 1,
                        cornerRadius: 8,
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            title: function(tooltipItems) {
                                return tooltipItems[0].label;
                            },
                            label: function(ctx) {
                                return `${ctx.dataset.label}: ${ctx.parsed.y} unidades`;
                            },
                            afterBody: function(tooltipItems) {
                                let total = 0;
                                tooltipItems.forEach(item => {
                                    total += item.parsed.y;
                                });
                                return `Total del d√≠a: ${total} unidades`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        stacked: false,
                        ticks: {
                            color: colors.text,
                            font: { size: 11 },
                            callback: function(value) {
                                return value + ' un.';
                            }
                        },
                        grid: { 
                            color: colors.grid,
                            drawBorder: false
                        },
                        title: {
                            display: true,
                            text: 'Cantidad (unidades)',
                            color: colors.text,
                            font: { size: 12, weight: 'bold' }
                        }
                    },
                    x: {
                        stacked: false,
                        ticks: { 
                            color: colors.text,
                            font: { size: 11 }
                        },
                        grid: { 
                            display: false 
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            }
        });

        // Event listener para cambio de cultivo
        selectCultivo.addEventListener('change', function() {
            const selected = this.value;
            const datosCultivo = obtenerDatosCultivo(selected);
            
            // Actualizar datos de los datasets
            calidadChart.data.datasets[0].data = datosCultivo.primera;
            calidadChart.data.datasets[1].data = datosCultivo.segunda;
            calidadChart.data.datasets[2].data = datosCultivo.tercera;
            
            // Actualizar t√≠tulo
            calidadChart.options.plugins.title.text = `Cosechas de ${selected} por Calidad`;
            
            // Aplicar cambios con animaci√≥n
            calidadChart.update('active');
            
        });

        console.log('‚úÖ Gr√°fico de calidad creado');
    } else {
        console.error('‚ùå No se pudo crear el gr√°fico de calidad - Elemento o datos faltantes');
        
    }

});
</script>

{% endblock %}

{% block modals %}
<!-- MODALES -->
<div class="modal fade" id="modalSeleccionarPlantacion" tabindex="-1" aria-labelledby="modalSeleccionarPlantacionLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Seleccionar Plantaci√≥n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <select id="selectPlantacion" class="form-select">
          <option value="">Selecciona una plantaci√≥n</option>
          {% for plantacion in plantaciones %}
            <option value="{{ plantacion.idplantacion }}">{{ plantacion.cultivo.nombre }} - Parcela: {{ plantacion.parcela.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="btnIrFormularioCorte" type="button" class="btn btn-success">Ir al formulario</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Seleccionar Proveedor -->
<div class="modal fade" id="modalSeleccionarProveedor" tabindex="-1" aria-labelledby="modalSeleccionarProveedorLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
  
        <div class="modal-header">
          <h5 class="modal-title">Listado de Proveedores</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
  
        <div class="modal-body">
          <select id="selectProveedor" class="form-select">
            <option value="">Selecciona un proveedor</option>
            {% for proveedor in proveedores %}
              <option value="{{ proveedor.idcliente }}">{{ proveedor.idcliente}}-{{ proveedor.nombre }} </option>
            {% endfor %}
          </select>
        </div>
  
        <div class="modal-footer">
          <button id="btnIrFormulario" class="btn btn-success">Ir al formulario</button>
        </div>
  
      </div>
    </div>
  </div>

  <!-- Modal Seleccionar Cliente -->
<div class="modal fade" id="modalSeleccionarCliente" tabindex="-1" aria-labelledby="modalSeleccionarClienteLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Listado de Cliente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <select id="selectCliente" class="form-select">
            <option value="">Selecciona un cliente</option>
            {% for cliente in clientes %}
              <option value="{{ cliente.idcliente }}">{{ cliente.idcliente}}-{{ cliente.nombre }} </option>
            {% endfor %}
          </select>
        </div>
        <div class="modal-footer">
          <button id="btnIrFormulario" class="btn btn-success">Ir al formulario</button>
        </div>
      </div>
    </div>
  </div>
{% endblock modals %}