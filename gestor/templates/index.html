{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %} | Dashboard {% endblock title %}

{% block content %}

<h1 class="welcome-title">¬°Bienvenido! {{ user }}</h1>
   
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-2">
    <h2 class="fw-bold text-center text-md-start">Sistema de producci√≥n</h2>
    <div class="d-flex flex-column flex-sm-row gap-2">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalSeleccionarCliente">
            <i class="bi bi-plus-circle"></i> Venta
        </button>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalSeleccionarPlantacion">
            <i class="bi bi-plus-circle"></i> Corte
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalSeleccionarProveedor">
            <i class="bi bi-plus-circle"></i> Compra
        </button>
        <a href="{% url 'agregarplanilla' %}" class="btn btn-success">
            <i class="fas fa-plus"></i> Asistencia
        </a>
    </div>
</div>

<!-- Resumen Diario -->
<h3 class="fw-bold mb-4">Resumen Diario</h3>

<div class="row g-3">

<!-- Tarjeta de Total de Cosechas -->
<div class="col-12 col-sm-6 col-lg-4">
    <div class="card h-100 text-white bg-success text-center shadow-sm">
        <div class="card-header fw-bold">
            <i class="bi bi-scissors"></i> Cosechas
        </div>
        <div class="card-body">
            <p class="mb-1 text-uppercase">Total del d√≠a</p>
            <p class="fw-bold fs-4">{{ total_cosechas_hoy|floatformat:0 }}</p>
            <small class="text-light">
                P: {{ cosechas_hoy.primera|floatformat:0 }} | 
                S: {{ cosechas_hoy.segunda|floatformat:0 }} | 
                T: {{ cosechas_hoy.tercera|floatformat:0 }}
            </small>
        </div>
    </div>
</div>

<!-- Cosechas detalladas por cultivo (si hay) -->
{% if cosechas_hoy_por_cultivo %}
    {% for cultivo, totales in cosechas_hoy_por_cultivo.items %}
    <div class="col-12 col-sm-6 col-lg-4">
        <div class="card shadow-sm border-success h-100">
            <div class="card-header bg-success text-white text-center fw-bold text-uppercase py-2 small">
                {{ cultivo }}
            </div>
            <div class="card-body p-2">
                <div class="row text-center">
                    <div class="col-4">
                        <div class="text-success fw-bold fs-5">{{ totales.primera|floatformat:0 }}</div>
                        <small class="text-muted">Primera</small>
                    </div>
                    <div class="col-4">
                        <div class="text-info fw-bold fs-5">{{ totales.segunda|floatformat:0 }}</div>
                        <small class="text-muted">Segunda</small>
                    </div>
                    <div class="col-4">
                        <div class="text-warning fw-bold fs-5">{{ totales.tercera|floatformat:0 }}</div>
                        <small class="text-muted">Tercera</small>
                    </div>
                </div>
                <hr class="my-2">
                <div class="text-center">
                    <span class="fw-bold text-dark">Total: {{ totales.primera|add:totales.segunda|add:totales.tercera|floatformat:0 }} unidades</span>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
{% endif %}

<!-- Ventas del d√≠a -->
<div class="col-12 col-md-6 col-lg-4">
    <div class="card h-100 text-white bg-primary text-center shadow-sm">
        <div class="card-header fw-bold">
            <i class="bi bi-cash-coin"></i> Ventas
        </div>
        <div class="card-body">
            <p class="mb-1 text-uppercase">Del d√≠a</p>
            <p class="fw-bold fs-4">${{ total_ventas|floatformat:2 }}</p>
        </div>
    </div>
</div>

<!-- Compras del d√≠a -->
<div class="col-12 col-md-6 col-lg-4">
    <div class="card h-100 text-white bg-secondary text-center shadow-sm">
        <div class="card-header fw-bold">
            <i class="bi bi-cart-fill"></i> Compras
        </div>
        <div class="card-body">
            <p class="mb-1 text-uppercase">Del d√≠a</p>
            <p class="fw-bold fs-4">${{ total_compras|floatformat:2 }}</p>
        </div>
    </div>
</div>

{% if not cosechas_hoy_por_cultivo and total_cosechas_hoy == 0 %}
<div class="col-12">
    <div class="alert alert-info text-center">
        <i class="bi bi-info-circle"></i> No hay cosechas registradas para hoy
    </div>
</div>
{% endif %}

</div>

<!-- Secci√≥n de gr√°ficos -->
<div class="row g-4 mb-4 mt-4">
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white fw-bold d-flex justify-content-between align-items-center">
                <span>Producci√≥n semanal</span>
                <div class="d-flex gap-2 align-items-center">
                    <label for="selectCultivo" class="text-white mb-0 small">Cultivo:</label>
                    <select id="selectCultivo" class="form-select form-select-sm" style="width: auto; background-color: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; min-width: 120px;">
                        {% if cultivos_semana_lista %}
                            {% for cultivo in cultivos_semana_lista %}
                                <option value="{{ cultivo }}" style="color: black;">{{ cultivo }}</option>
                            {% endfor %}
                        {% else %}
                            <option value="" style="color: gray;">Sin datos</option>
                        {% endif %}
                    </select>
                </div>
            </div>
            <div class="card-body">
                {% if cultivos_semana_lista %}
                    <canvas id="calidadChart" style="height: 350px;"></canvas>
                {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-bar-chart-line fs-1"></i>
                        <p class="mt-2">No hay datos de cosechas para mostrar esta semana</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white fw-bold d-flex justify-content-between align-items-center">
                <span>Ventas y Compras Semanales</span>
                <div class="form-check form-switch" style="margin: 0;">
                    <input class="form-check-input" type="checkbox" id="toggleCompras" checked>
                    <label class="form-check-label text-white small" for="toggleCompras">
                        Mostrar compras
                    </label>
                </div>
            </div>
            <div class="card-body">
                <canvas id="ventasChart" style="height: 350px;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Scripts y datos para JavaScript -->
<script>
// Pasar datos de Django a JavaScript
window.dashboardData = {
    diasSemana: {{ dias_semana|safe }},
    ventasPorDia: {{ ventas_por_dia|safe }},
    comprasPorDia: {{ compras_por_dia|safe }},
    calidadPorCultivo: {{ calidad_por_cultivo|safe }},
    cultivosSemana: {{ cultivos_semana|safe }},
    cultivosHoy: {{ cultivos_hoy|safe }}
};

console.log('üìä Datos recibidos del servidor:', window.dashboardData);
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Verificar que los datos est√©n disponibles
    if (!window.dashboardData) {
        console.error('‚ùå No se encontraron datos del dashboard');
        return;
    }

    const { diasSemana, ventasPorDia, comprasPorDia, calidadPorCultivo, cultivosSemana, cultivosHoy } = window.dashboardData;

    // Funci√≥n para detectar si estamos en modo oscuro
    function getChartColors() {
        const dark = document.body.classList.contains('dark-mode') || 
                     document.documentElement.classList.contains('dark-mode') ||
                     window.matchMedia('(prefers-color-scheme: dark)').matches;
        return {
            text: dark ? '#ffffff' : '#333333',
            grid: dark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
            tooltipBg: dark ? '#2d2d2d' : '#ffffff',
            tooltipText: dark ? '#ffffff' : '#000000'
        };
    }

    const colors = getChartColors();

    // C√ìDIGO PARA BOTONES DE MODALES
    const btnCorte = document.getElementById("btnIrFormularioCorte");
    const btnVenta = document.getElementById("btnIrFormularioVenta");
    const btnCompra = document.getElementById("btnIrFormularioCompra");

    if (btnCorte) {
        btnCorte.addEventListener("click", function () {
            const plantacionId = document.getElementById("selectPlantacion")?.value;
            if (plantacionId) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalSeleccionarPlantacion'));
                if (modal) modal.hide();
                setTimeout(() => {
                    window.location.href = `/cosechas/crear/?plantacion_id=${plantacionId}`;
                }, 300);
            } else {
                alert("Debes seleccionar una plantaci√≥n.");
            }
        });
    }

    if (btnVenta) {
        btnVenta.addEventListener("click", function () {
            const clienteId = document.getElementById("selectCliente")?.value;
            if (clienteId) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalSeleccionarCliente'));
                if (modal) modal.hide();
                setTimeout(() => {
                    window.location.href = `/ventas/crear/?cliente_id=${clienteId}`;
                }, 300);
            } else {
                alert("Debes seleccionar un cliente.");
            }
        });
    }

    if (btnCompra) {
        btnCompra.addEventListener("click", function () {
            const proveedorId = document.getElementById("selectProveedor")?.value;
            if (proveedorId) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalSeleccionarProveedor'));
                if (modal) modal.hide();
                setTimeout(() => {
                    window.location.href = `/compras/crear/?proveedor_id=${proveedorId}`;
                }, 300);
            } else {
                alert("Debes seleccionar un proveedor.");
            }
        });
    }

    // 1. GR√ÅFICO DE VENTAS Y COMPRAS
    const ventasChartElement = document.getElementById('ventasChart');
    const toggleCompras = document.getElementById('toggleCompras');
    
    if (ventasChartElement && diasSemana && ventasPorDia) {
        const datasets = [
            {
                label: 'Ventas ($)',
                data: ventasPorDia,
                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false,
                type: 'bar'
            }
        ];

        if (comprasPorDia && toggleCompras.checked) {
            datasets.push({
                label: 'Compras ($)',
                data: comprasPorDia,
                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false,
                type: 'bar'
            });
        }

        const ventasChart = new Chart(ventasChartElement, {
            type: 'bar',
            data: {
                labels: diasSemana,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Ventas y Compras de la Semana',
                        color: colors.text,
                        font: { size: 16, weight: 'bold' },
                        padding: { bottom: 20 }
                    },
                    legend: {
                        display: true,
                        labels: { 
                            color: colors.text,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        backgroundColor: colors.tooltipBg,
                        titleColor: colors.tooltipText,
                        bodyColor: colors.tooltipText,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(ctx) {
                                return ctx.dataset.label + ': $' + ctx.parsed.y.toLocaleString('es-ES', {
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 2
                                });
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: colors.text,
                            font: { size: 11 },
                            callback: function(value) {
                                return '$' + value.toLocaleString('es-ES');
                            }
                        },
                        grid: { 
                            color: colors.grid,
                            drawBorder: false
                        },
                        title: {
                            display: true,
                            text: 'Monto ($)',
                            color: colors.text,
                            font: { size: 12, weight: 'bold' }
                        }
                    },
                    x: {
                        ticks: { 
                            color: colors.text,
                            font: { size: 11 }
                        },
                        grid: { 
                            display: false 
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                }
            }
        });

        // Toggle para mostrar/ocultar compras
        toggleCompras.addEventListener('change', function() {
            if (this.checked && comprasPorDia) {
                // Agregar dataset de compras
                ventasChart.data.datasets.push({
                    label: 'Compras ($)',
                    data: comprasPorDia,
                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 2,
                    borderRadius: 8,
                    borderSkipped: false,
                    type: 'bar'
                });
            } else {
                // Remover dataset de compras
                ventasChart.data.datasets = ventasChart.data.datasets.filter(ds => ds.label !== 'Compras ($)');
            }
            ventasChart.update();
        });
    }

    // 2. GR√ÅFICO DE COSECHAS POR CULTIVO
    const calidadChartElement = document.getElementById('calidadChart');
    const selectCultivo = document.getElementById('selectCultivo');
    
    if (calidadChartElement && selectCultivo && calidadPorCultivo && cultivosSemana.length > 0) {
        let cultivoSeleccionado = cultivosSemana[0]; // Primer cultivo por defecto
        selectCultivo.value = cultivoSeleccionado;
        
        function obtenerDatosCultivo(cultivo) {
            const datos = calidadPorCultivo[cultivo];
            if (!datos) {
                console.warn(`‚ö†Ô∏è No hay datos para el cultivo: ${cultivo}`);
                return {
                    primera: [0,0,0,0,0,0,0],
                    segunda: [0,0,0,0,0,0,0],
                    tercera: [0,0,0,0,0,0,0]
                };
            }
            return datos;
        }

        const calidadChart = new Chart(calidadChartElement, {
            type: 'bar',
            data: {
                labels: diasSemana,
                datasets: [
                    {
                        label: 'Primera Calidad',
                        data: obtenerDatosCultivo(cultivoSeleccionado).primera,
                        backgroundColor: 'rgba(34, 197, 94, 0.8)',
                        borderColor: 'rgba(34, 197, 94, 1)',
                        borderWidth: 2,
                        borderRadius: 4
                    },
                    {
                        label: 'Segunda Calidad',
                        data: obtenerDatosCultivo(cultivoSeleccionado).segunda,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        borderRadius: 4
                    },
                    {
                        label: 'Tercera Calidad',
                        data: obtenerDatosCultivo(cultivoSeleccionado).tercera,
                        backgroundColor: 'rgba(245, 158, 11, 0.8)',
                        borderColor: 'rgba(245, 158, 11, 1)',
                        borderWidth: 2,
                        borderRadius: 4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `Cosechas de ${cultivoSeleccionado} (Semana Actual)`,
                        color: colors.text,
                        font: { size: 16, weight: 'bold' },
                        padding: { bottom: 20 }
                    },
                    legend: {
                        display: true,
                        position: 'top',
                        labels: { 
                            color: colors.text,
                            font: { size: 12 },
                            padding: 15
                        }
                    },
                    tooltip: {
                        backgroundColor: colors.tooltipBg,
                        titleColor: colors.tooltipText,
                        bodyColor: colors.tooltipText,
                        borderColor: 'rgba(34, 197, 94, 1)',
                        borderWidth: 1,
                        cornerRadius: 8,
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            title: function(tooltipItems) {
                                return tooltipItems[0].label;
                            },
                            label: function(ctx) {
                                return `${ctx.dataset.label}: ${ctx.parsed.y} unidades`;
                            },
                            afterBody: function(tooltipItems) {
                                let total = 0;
                                tooltipItems.forEach(item => {
                                    total += item.parsed.y;
                                });
                                return `Total del d√≠a: ${total} unidades`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        stacked: false,
                        ticks: {
                            color: colors.text,
                            font: { size: 11 },
                            callback: function(value) {
                                return value + ' un.';
                            }
                        },
                        grid: { 
                            color: colors.grid,
                            drawBorder: false
                        },
                        title: {
                            display: true,
                            text: 'Cantidad (unidades equivalentes)',
                            color: colors.text,
                            font: { size: 12, weight: 'bold' }
                        }
                    },
                    x: {
                        stacked: false,
                        ticks: { 
                            color: colors.text,
                            font: { size: 11 }
                        },
                        grid: { 
                            display: false 
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            }
        });

        // Event listener para cambio de cultivo
        selectCultivo.addEventListener('change', function() {
            const selected = this.value;
            const datosCultivo = obtenerDatosCultivo(selected);
            
            // Actualizar datos de los datasets
            calidadChart.data.datasets[0].data = datosCultivo.primera;
            calidadChart.data.datasets[1].data = datosCultivo.segunda;
            calidadChart.data.datasets[2].data = datosCultivo.tercera;
            
            // Actualizar t√≠tulo
            calidadChart.options.plugins.title.text = `Cosechas de ${selected} (Semana Actual)`;
            
            // Aplicar cambios con animaci√≥n
            calidadChart.update('active');
        });

        console.log('‚úÖ Gr√°fico de cosechas creado');
    } else {
        console.error('‚ùå No se pudo crear el gr√°fico de cosechas - Elemento o datos faltantes');
    }

});
</script>

{% endblock %}

{% block modals %}
<!-- MODALES -->
<div class="modal fade" id="modalSeleccionarPlantacion" tabindex="-1" aria-labelledby="modalSeleccionarPlantacionLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Seleccionar Plantaci√≥n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <select id="selectPlantacion" class="form-select">
          <option value="">Selecciona una plantaci√≥n</option>
          {% for plantacion in plantaciones %}
            <option value="{{ plantacion.idplantacion }}">{{ plantacion.cultivo.nombre }} - Parcela: {{ plantacion.parcela.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="btnIrFormularioCorte" type="button" class="btn btn-success">Ir al formulario</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Seleccionar Proveedor -->
<div class="modal fade" id="modalSeleccionarProveedor" tabindex="-1" aria-labelledby="modalSeleccionarProveedorLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Listado de Proveedores</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <select id="selectProveedor" class="form-select">
            <option value="">Selecciona un proveedor</option>
            {% for proveedor in proveedores %}
              <option value="{{ proveedor.idcliente }}">{{ proveedor.idcliente}}-{{ proveedor.nombre }} </option>
            {% endfor %}
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="btnIrFormularioCompra" type="button" class="btn btn-success">Ir al formulario</button>
        </div>
      </div>
    </div>
</div>

<!-- Modal Seleccionar Cliente -->
<div class="modal fade" id="modalSeleccionarCliente" tabindex="-1" aria-labelledby="modalSeleccionarClienteLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Listado de Cliente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <select id="selectCliente" class="form-select">
            <option value="">Selecciona un cliente</option>
            {% for cliente in clientes %}
              <option value="{{ cliente.idcliente }}">{{ cliente.idcliente}}-{{ cliente.nombre }} </option>
            {% endfor %}
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="btnIrFormularioVenta" type="button" class="btn btn-success">Ir al formulario</button>
        </div>
      </div>
    </div>
</div>
{% endblock modals %}