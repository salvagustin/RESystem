{% extends 'base.html' %}
{% block title %} | Reportes {% endblock %}
{% block content %}
<div class="container py-2">
    <!-- Título -->
    <div class="text-center mb-4">
        <h1 class="fw-bold text-primary">Reportes</h1>
        <p class="text-muted">Análisis detallado de producción y rendimiento</p>
    </div>

    <!-- Resumen de Producción por Cultivo -->
    <h3 class="fw-bold mb-4">Producción por Cultivo</h3>
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3 mb-5">
        {% for cultivo, datos in produccion_por_cultivo.items %}
        <div class="col">
            <div class="card h-100 shadow-sm border-success">
                <div class="card-header bg-success text-white text-center fw-bold text-uppercase">
                    {{ cultivo }}
                </div>
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-success fw-bold">Primera</span>
                        <span class="fw-bold">{{ datos.primera }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-info fw-bold">Segunda</span>
                        <span class="fw-bold">{{ datos.segunda }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-warning fw-bold">Tercera</span>
                        <span class="fw-bold">{{ datos.tercera }}</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-dark fw-bold">Total</span>
                        <span class="fw-bold fs-5 text-primary">{{ datos.total }}</span>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Estadísticas Generales -->
    <h3 class="fw-bold mb-4">Estadísticas Generales</h3>
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3 mb-5">
        {% for tipo, cantidad in produccion_por_tipo_parcela.items %}
        <div class="col">
            <div class="card h-100 text-white {% if tipo == 'Campo abierto' %}bg-info{% else %}bg-warning{% endif %} text-center shadow-sm">
                <div class="card-header fw-bold">{{ tipo }}</div>
                <div class="card-body">
                    <p class="mb-1 text-uppercase">Producción Total</p>
                    <p class="fw-bold fs-4">{{ cantidad }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
        <div class="col">
            <div class="card h-100 text-white bg-secondary text-center shadow-sm">
                <div class="card-header fw-bold">Parcelas</div>
                <div class="card-body">
                    <p class="mb-1 text-uppercase">Ocupadas</p>
                    <p class="fw-bold fs-4">
                        {% for parcela, estado in estado_parcelas.items %}
                            {% if estado == 'Ocupada' %}{{ forloop.counter }}{% endif %}
                        {% endfor %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row g-4 mb-5">
        <div class="col-12 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white fw-bold">
                    Producción por Calidad
                </div>
                <div class="card-body">
                    <canvas id="graficoCalidadTotal"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white fw-bold">
                    Producción por Tipo de Parcela
                </div>
                <div class="card-body">
                    <canvas id="graficoTipoParcela"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white fw-bold">
                    Ciclo Promedio por Cultivo (días)
                </div>
                <div class="card-body">
                    <canvas id="graficoCicloPromedio"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Rendimiento por Plantación -->
    <h3 class="fw-bold mb-4">Rendimiento por Plantación</h3>
    <div class="row g-3 mb-5">
        {% for id, datos in rendimiento_por_plantacion.items %}
        <div class="col-12 col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-light fw-bold">
                    {{ datos.cultivo }} - {{ datos.parcela }}
                </div>
                <div class="card-body text-center">
                    <h4 class="text-primary">{{ datos.rendimiento }}</h4>
                    <small class="text-muted">unidades por planta</small>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Estado de Parcelas -->
    <h3 class="fw-bold mb-4">Estado de Parcelas</h3>
    <div class="row g-3 mb-5">
        {% for parcela, estado in estado_parcelas.items %}
        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
            <div class="card h-100 shadow-sm {% if estado == 'Ocupada' %}border-danger{% else %}border-success{% endif %}">
                <div class="card-body text-center">
                    <h6 class="card-title">{{ parcela }}</h6>
                    <span class="badge {% if estado == 'Ocupada' %}bg-danger{% else %}bg-success{% endif %}">
                        {{ estado }}
                    </span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Historial de Cultivos por Parcela -->
    <h3 class="fw-bold mb-4">Historial por Parcela</h3>
    <div class="accordion" id="historialAccordion">
        {% for parcela, cultivos in historial_por_parcela.items %}
        <div class="accordion-item">
            <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                        data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="false">
                    <strong>{{ parcela }}</strong>
                </button>
            </h2>
            <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse" 
                 data-bs-parent="#historialAccordion">
                <div class="accordion-body">
                    <div class="row g-2">
                        {% for cultivo in cultivos %}
                        <div class="col-12 col-md-6">
                            <div class="card h-100">
                                <div class="card-body p-3">
                                    <h6 class="card-title">{{ cultivo.cultivo }}</h6>
                                    <p class="card-text small mb-1">
                                        <strong>Variedad:</strong> {{ cultivo.variedad }}<br>
                                        <strong>Fecha:</strong> {{ cultivo.fecha }}<br>
                                        <strong>Estado:</strong> 
                                        <span class="badge {% if cultivo.estado == 'Activa' %}bg-success{% else %}bg-secondary{% endif %}">
                                            {{ cultivo.estado }}
                                        </span>
                                    </p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Datos desde Django
    const produccionPorCultivo = {{ produccion_por_cultivo|safe }};
    let produccionPorTipo = {{ produccion_por_tipo_parcela|safe }};
    let cicloPromedio = {{ ciclo_promedio|safe }};

    // Gráfico de Producción por Calidad
    let ctxCalidad = document.getElementById('graficoCalidadTotal').getContext('2d');
    let cultivos = Object.keys(produccionPorCultivo);
    let dataPrimera = cultivos.map(c => produccionPorCultivo[c].primera);
    let dataSegunda = cultivos.map(c => produccionPorCultivo[c].segunda);
    let dataTercera = cultivos.map(c => produccionPorCultivo[c].tercera);

    new Chart(ctxCalidad, {
        type: 'bar',
        data: {
            labels: cultivos,
            datasets: [{
                label: 'Primera',
                data: dataPrimera,
                backgroundColor: 'rgba(40, 167, 69, 0.8)',
                borderColor: 'rgba(40, 167, 69, 1)',
                borderWidth: 1
            }, {
                label: 'Segunda',
                data: dataSegunda,
                backgroundColor: 'rgba(23, 162, 184, 0.8)',
                borderColor: 'rgba(23, 162, 184, 1)',
                borderWidth: 1
            }, {
                label: 'Tercera',
                data: dataTercera,
                backgroundColor: 'rgba(255, 193, 7, 0.8)',
                borderColor: 'rgba(255, 193, 7, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true },
                x: { stacked: false }
            },
            plugins: {
                legend: { display: true }
            }
        }
    });

    // Gráfico de Producción por Tipo de Parcela
    const ctxTipo = document.getElementById('graficoTipoParcela').getContext('2d');
    new Chart(ctxTipo, {
        type: 'doughnut',
        data: {
            labels: Object.keys(produccionPorTipo),
            datasets: [{
                label: 'Producción',
                data: Object.values(produccionPorTipo),
                backgroundColor: [
                    'rgba(23, 162, 184, 0.8)',
                    'rgba(255, 193, 7, 0.8)'
                ],
                borderColor: [
                    'rgba(23, 162, 184, 1)',
                    'rgba(255, 193, 7, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });

    // Gráfico de Ciclo Promedio
    const ctxCiclo = document.getElementById('graficoCicloPromedio').getContext('2d');
    new Chart(ctxCiclo, {
        type: 'bar',
        data: {
            labels: Object.keys(cicloPromedio),
            datasets: [{
                label: 'Días promedio',
                data: Object.values(cicloPromedio),
                backgroundColor: 'rgba(23, 162, 184, 0.8)',
                borderColor: 'rgba(23, 162, 184, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { 
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Días'
                    }
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
});
</script>
{% endblock scripts %}1w
